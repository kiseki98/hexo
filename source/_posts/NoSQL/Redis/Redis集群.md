---
title: Redis集群
date: 2022/7/15 20:46:25
tags:
- NoSQL
- Redis
categories:
- [NoSQL, Redis]
description: Redis集群
---

# Redis集群

## 主从复制

1. 主从连接(三种)
    1. 客户端命令：`slaveof <masterip> <masterport>`
    2. 启动参数：`redis-server -slaveof <masterip> <masterport>`
    3. 配置文件：`slaveof <masterip> <masterport>`
    4. 断开连接：客户端 `slaveof no one`，不删除 `slave` 数据，只是不接受`master`数据
2. 心跳机制
    1. `slave`：1秒发送一次，汇报 `salve` 偏移量，获取最新数据变更指令
    2. `master`：判断 `slaver` 是否在线，默认10秒发送一次
    3. 当多数 `slave` 掉线或延迟过高，`master `为保证数据稳定，拒绝信息同步
3. 主从复制流程
    1. 建立连接
    2. 数据同步
        1. 全量复制：`RDB` 同步数据，此后 `master` 收到的修改 `key` 的指令存入缓冲区中，如果全量复制周期过长，缓冲区溢出，导致数据丢失，重新进行全量复制
        2. 增量复制：`master ` 发送缓冲区数据，`master` 个 `slaver` 同时记录缓冲区同步的位置(缓冲区偏移量)
    3. 命令传播
        1. 定义：`master` 数据库状态被修改，导致主从数据库状态不一致，此时主从同步的动作称为命令传播
        2. 命令传播出现断网：网络闪断闪连：忽略；短时间中断：增量复制；长时间中断：全量复制
        3. 复制核心三要素：服务器运行`id`(`run id`，运行时生成)，`master`积压复制缓冲区，主从服务器的复制偏移量
    4. 复制缓冲区：开启 `AOF` 或者作为 `master` 时创建
        1. 定义：复制缓冲区，`FIFO` 的队列，每次传播命令，存储 `master` 执行过的命令
        2. 组成：保存指令的字符和字符对应的偏移量(对比 `master` 和 `slave` 差异，恢复数据使用)

![Image](https://img-1301279461.cos.ap-nanjing.myqcloud.com/img/Image.png)

Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下：
-  从服务器连接主服务器，发送SYNC命令；
-  主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；
-  主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；
-  从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；
-  主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；
-  从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；
   增量同步

Redis增量复制是指Slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。
增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。
![](https://img-1301279461.cos.ap-nanjing.myqcloud.com/img/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.png)

## 哨兵模式

1. 概念：哨兵也是一台 `Redis` 服务器，只是不提供数据服务，哨兵 `sentinel` 是一个分布式系统，用于对主从结构中的每台服务器进行监控，当出现故障时通过投票机制选择新的 `master` 并将所有 `slave` 连接到新的 `master`
2. 作用
    1. 监控：同步信息
        1. 获取 `master` 的状态：`master` 属性，各个 `slave` 的详细信息
        2. 获取所有 `slave` 的状态，根据 `master` 中的 `slave` 信息
        3. 获取各个 `sentinel` 的状态（是否在线）
    2. 通知：当被监控的服务器出现问题时，向其他（哨兵间，客户端）发送通知。
    3. 故障转移
        1. 发现问题：哨兵发现`master`下线`sdown`，通知其他哨兵，超过半数哨兵认为 `master` 下线 `odown`
        2. 竞选负责人：选出一个哨兵来负责处理故障转移过程
        3. 服务器列表挑选备选`master`：在线，`offset`最小(延迟小)
        4. 新 `master` 上任：其他 `slave` 切换 `master`，原 `master` 故障回复后作为 `slave` 连接

## Cluster集群

1. 概念：集群就是使用网络将若干台计算机联通起来，并提供统一的管理方式，使其对外呈现单机的服务效果
2. 作用
    1. 分散单台服务器的访问压力，实现负载均衡
    2. 分散单台服务器的存储压力，实现可扩展性
    3. 降低单台服务器宕机带来的业务灾难
3. 存储设计(类似 `HashMap`)
    1. `Redis`将键名有效部分使用`CRC16`算法计算出散列值，对`16384`取余，计算出`key`应该保存的位置，分配到`16384`个槽中，进而分配到指定的节点中处理
    2. 将所有的存储空间计切割成`16384`份，每台主机保存一部分槽(每台`master`存储的`key`都是不一样的)
    3. 将`key`按照计算出的结果放到对应的存储空间
4. 集群的通信：最多两次命中
    1. 每个 `master` 都保存其他 `master` 的信息(各个库包含槽的编号)
    2. 一次查找未命中，从库中得到查找 `key` 的槽位(对应 `master` 也找到)
